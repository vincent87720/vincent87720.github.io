<!DOCTYPE html><html lang="zh-Hant"> <head><meta charset="UTF-8"><meta name="description" content="柴魚筆記"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.10.3"><title>柴魚筆記</title><link rel="stylesheet" href="/assets/style.HZtN7SYH.css"></head> <body>  <div class="nav-outer" data-astro-cid-pux6a34n> <nav class="nav-inner" data-astro-cid-pux6a34n> <span class="logo" data-astro-cid-pux6a34n> <a href="/" data-astro-cid-pux6a34n> <img src="/favicon.svg" data-astro-cid-pux6a34n> </a> </span> <ul data-astro-cid-pux6a34n> <li data-astro-cid-pux6a34n> <a href="/" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Home</span> </a> </li><li data-astro-cid-pux6a34n> <a href="/author/Katsuobushi" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Author</span> </a> </li><li data-astro-cid-pux6a34n> <a href="/tags" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Tags</span> </a> </li> </ul> </nav> </div>   <header class="main-header has-cover" data-astro-cid-yl355ysp> <div class="content" data-astro-cid-yl355ysp> <div class="header-box" data-astro-cid-yl355ysp>  <div class="post-info" data-astro-cid-qwcrhz7j> <div class="post-type" data-astro-cid-qwcrhz7j> <span data-astro-cid-qwcrhz7j>Article</span>  <span class="post-type-dash" data-astro-cid-qwcrhz7j>－</span> <span data-astro-cid-qwcrhz7j>ASP.NET Core</span>  </div> <h1 class="post-title" data-astro-cid-qwcrhz7j>使用ASP.NET Core Web API提供HLS影片串流服務</h1> <div class="post-metadata" data-astro-cid-qwcrhz7j> <span class="author-avatar" data-astro-cid-qwcrhz7j> <img src="/favicon.svg" data-astro-cid-qwcrhz7j> </span> <div class="metadata-right" data-astro-cid-qwcrhz7j> <h4 class="metadata-author" data-astro-cid-qwcrhz7j>Katsuobushi</h4> <span class="metadata-datetime" data-astro-cid-qwcrhz7j>2023-09-10T00:00:00+08:00</span> </div> </div> </div>   </div> <div class="main-cover" data-astro-cid-yl355ysp> <img src="/assets/Waterfall_JonatanLewczuk_unsplash.CP2cTJcH_ZT05Sr.webp" alt="" data-astro-cid-yl355ysp width="2400" height="1600" loading="lazy" decoding="async"> </div> </div> </header>  <article> <div class="content"> <div class="markdown">  <p>公司的APP其中一個功能是影片上傳及串流的服務，這陣子比較了許多影片串流及直播的通訊協定，最後選擇使用HLS協定來提供影片串流服務，流程包括「建立影片上傳API」、「影片轉檔」及「建立串流API」，這篇筆記記錄如何使用 ASP.NET Core Web API 來建立影音串流服務。</p>
<h2 id="檔案結構">檔案結構</h2>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#F97583">|</span><span style="color:#B392F0">--</span><span style="color:#9ECBFF"> Example</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--Program.cs</span><span style="color:#6A737D">          #程式進入點</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--Example.csproj</span><span style="color:#6A737D">      #CSharp專案檔</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--ApiControllers</span><span style="color:#6A737D">      #存放API</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--MultimediaController.cs</span><span style="color:#6A737D"> #提供多媒體上傳及下載的API</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--Models</span><span style="color:#6A737D">              #資料表模型存放資料夾</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--Multimedia.cs</span><span style="color:#6A737D">  #用於存放影音資訊的模型</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--Services</span><span style="color:#6A737D">                     #服務存放資料夾</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--MultimediaService.cs</span><span style="color:#6A737D">    #提供多媒體服務</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--FileService.cs</span><span style="color:#6A737D">          #提供檔案操作服務</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--HLSService.cs</span><span style="color:#6A737D">           #提供HLS串流服務</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#F97583">    |</span><span style="color:#B392F0">--FFMpeg</span><span style="color:#6A737D">                       #FFMpeg可執行檔（官網下載）</span></span>
<span class="line"><span style="color:#F97583">|</span></span>
<span class="line"><span style="color:#F97583">|</span><span style="color:#B392F0">--</span><span style="color:#9ECBFF"> Example.sln</span><span style="color:#6A737D">             #專案</span></span>
<span class="line"></span></code></pre>
<h2 id="影片上傳">影片上傳</h2>
<h3 id="建立上傳影片服務">建立上傳影片服務</h3>
<p>上傳影片會用到<code>IFormFile</code>這個介面，<code>IFormFile</code>用來處理或儲存檔案，我們在<code>Services</code>目錄底下的<code>MultimediaService.cs</code>檔案裡新增<code>CreateMultimedia</code>函式並傳入型別為<code>IFormFile</code>的參數。</p>
<p>首先取得檔案的副檔名，同時產生一個新檔名，接著建立一個Multimedia的物件，將資訊存放進去。</p>
<p>這裡我們使用注入方式將資料庫注入，已建立好的Multimedia物件使用被注入的_dbContext加入到資料庫中，並且呼叫SaveChanges保存變動。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaService</span></span>
<span class="line"><span style="color:#E1E4E8">{    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> DBContext</span><span style="color:#B392F0"> _dbContext</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">DBContext</span><span style="color:#B392F0"> dbContext</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#6A737D">        //注入資料庫Context，用於對資料庫進行CRUD</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> dbContext;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> CreateMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#6A737D">        //取得副檔名</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> fileExt</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">GetExtension</span><span style="color:#E1E4E8">(file.FileName);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //產生一個新隨機檔名，避免檔名重複</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> fileNewName</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">GetRandomFileName</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //產生一個Multimedia物件，呼叫Add方法加入Multimedia資料表，</span></span>
<span class="line"><span style="color:#6A737D">        //最後使用_dbContext.SaveChanges()儲存更動</span></span>
<span class="line"><span style="color:#B392F0">        Multimedia</span><span style="color:#B392F0"> multimedia</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Multimedia</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            Uid </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Guid.</span><span style="color:#B392F0">NewGuid</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            Type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.ContentType,</span></span>
<span class="line"><span style="color:#E1E4E8">            Size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.Length,</span></span>
<span class="line"><span style="color:#E1E4E8">            Ext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fileExt,</span></span>
<span class="line"><span style="color:#E1E4E8">            Name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fileNewName,</span></span>
<span class="line"><span style="color:#E1E4E8">            RecordId </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.RecordId</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> mmedia</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> _dbContext.Multimedia.</span><span style="color:#B392F0">Add</span><span style="color:#E1E4E8">(multimedia);</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext.</span><span style="color:#B392F0">SaveChanges</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>這個檔案先寫到這，我們先建立資料儲存及轉檔的程式，接著才會把所有服務都串起來。</p>
<p>除了在資料庫存放檔案資訊外，還需要在實體目錄中存放實體影音檔案提供串流及下載，我們在<code>Services</code>目錄底下新增<code>FileService.cs</code>，用於提供檔案儲存及讀取的操作。</p>
<p><code>WriteFile</code>函式傳入要寫入到本機的檔案、檔案名稱及副檔名，檢查目的目錄是否存在，並使用CopyToAsync及Stream寫入檔案。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//FileService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> FileService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6A737D">    //設定檔案存放位置</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#F97583"> string</span><span style="color:#B392F0"> basePath</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "./MultimediaFiles/"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> WriteFile</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileName</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileExt</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#6A737D">        //使用Path.Combine合併多個路徑，避免多餘的'/'符號產生</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> filePath</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">Combine</span><span style="color:#E1E4E8">(basePath, fileName);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //判斷目標目錄是否存在，不存在便創建目錄</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (Directory.</span><span style="color:#B392F0">Exists</span><span style="color:#E1E4E8">(basePath) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            Directory.</span><span style="color:#B392F0">CreateDirectory</span><span style="color:#E1E4E8">(basePath);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //建立檔案並指定給stream</span></span>
<span class="line"><span style="color:#B392F0">        Stream</span><span style="color:#B392F0"> stream</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> File.</span><span style="color:#B392F0">Create</span><span style="color:#E1E4E8">(filePath </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> fileExt);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //使用IFormFile的CopyToAsync方法，將file放入stream</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> file.</span><span style="color:#B392F0">CopyToAsync</span><span style="color:#E1E4E8">(stream);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //關閉stream</span></span>
<span class="line"><span style="color:#E1E4E8">        stream.</span><span style="color:#B392F0">Close</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>此時我們已經能夠將檔案寫入本機目錄中了，接著便是我們今天的重頭戲－轉檔</p>
<h3 id="影片轉檔為m3u8格式">影片轉檔為m3u8格式</h3>
<p>不免俗的我們再來建立一個服務</p>
<p>在<code>Services</code>目錄底下新增<code>HLSService.cs</code>，用於提供HLS的轉檔服務。</p>
<p>這裡使用FFMpeg進行轉檔，使用FFMpeg進行轉檔除了要使用NuGet安裝<code>FFMpegCore</code>Package之外，還要去官網下載FFMpeg的可執行檔，放入專案目錄中。</p>
<p>建立一個WriteFile函式，在函式內使用<code>FFMpegArguments</code>類別進行設定及轉檔。</p>
<p><code>FromFileInput</code>可以用於指定輸入檔案的路徑
<code>OutputToFile</code>可以用於指定輸出檔案路徑
<code>ProcessAsynchronously</code>用於執行轉檔</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//HLSService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">using</span><span style="color:#B392F0"> FFMpegCore</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> HLSService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#F97583"> string</span><span style="color:#B392F0"> basePath</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "./MultimediaFiles/"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> WriteFile</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileName</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileExt</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#6A737D">        //判斷目標目錄是否存在，不存在便創建目錄</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> filePath</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">Combine</span><span style="color:#E1E4E8">(basePath, fileName);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (Directory.</span><span style="color:#B392F0">Exists</span><span style="color:#E1E4E8">(basePath) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            Directory.</span><span style="color:#B392F0">CreateDirectory</span><span style="color:#E1E4E8">(basePath);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> FFMpegArguments</span></span>
<span class="line"><span style="color:#E1E4E8">            .</span><span style="color:#B392F0">FromFileInput</span><span style="color:#E1E4E8">(filePath </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> fileExt)</span><span style="color:#6A737D">//輸入路徑後方必須包含原檔的副檔名</span></span>
<span class="line"><span style="color:#E1E4E8">            .</span><span style="color:#B392F0">OutputToFile</span><span style="color:#E1E4E8">(filePath </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> ".m3u8"</span><span style="color:#E1E4E8">)</span><span style="color:#6A737D">//輸出路徑後方必須包含".m3u8"副檔名</span></span>
<span class="line"><span style="color:#E1E4E8">            .</span><span style="color:#B392F0">ProcessAsynchronously</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>到這邊已經可以將影片檔轉為m3u8及ts檔了，接著就是要把剛才的所有步驟串起來，我們把剛剛的步驟都串到<code>MultimediaService</code>裡的<code>CreateMultimedia</code>函式裡面。</p>
<h3 id="包裝上傳流程">包裝上傳流程</h3>
<p>剛才在<code>FileService</code>建立了<code>WriteFile</code>方法，用於將檔案寫入目錄中，在<code>HLSService</code>也建立了<code>WriteFile</code>方法，用於進行影片轉檔，我們接著要把這些服務串起來。</p>
<p>目前<code>MultimediaService</code>中的<code>CreateMultimedia</code>函式寫到新增影片資訊到資料庫，接著<code>_dbContext.SaveChanges();</code>的後面加入寫檔及轉檔的服務。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaService</span></span>
<span class="line"><span style="color:#E1E4E8">{    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> DBContext</span><span style="color:#B392F0"> _dbContext</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> FileService</span><span style="color:#B392F0"> _file</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> HLSService</span><span style="color:#B392F0"> _hls</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">DBContext</span><span style="color:#B392F0"> dbContext</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">FileService</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">HLSService</span><span style="color:#B392F0"> hls</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> dbContext;</span></span>
<span class="line"><span style="color:#E1E4E8">        _file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file;</span></span>
<span class="line"><span style="color:#E1E4E8">        _hls </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hls;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    //注意必須使用async將此函式指定為非同步，</span></span>
<span class="line"><span style="color:#6A737D">    //因為_file.WriteFile及_hls.WriteFile函式都是非同步方法，必須被等待</span></span>
<span class="line"><span style="color:#6A737D">    //除了加入async以外也必須加入Task，Task代表不會回傳值且以非同步方式執行函式</span></span>
<span class="line"><span style="color:#6A737D">    //若使用void，函式的呼叫端無法加上await，會導致呼叫端無法攔截例外</span></span>
<span class="line"><span style="color:#6A737D">    //容易造成靈異現象</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> CreateMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> fileExt</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">GetExtension</span><span style="color:#E1E4E8">(file.FileName);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> fileNewName</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">GetRandomFileName</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#B392F0">        Multimedia</span><span style="color:#B392F0"> multimedia</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Multimedia</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            Uid </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Guid.</span><span style="color:#B392F0">NewGuid</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            Type </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.ContentType,</span></span>
<span class="line"><span style="color:#E1E4E8">            Size </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file.Length,</span></span>
<span class="line"><span style="color:#E1E4E8">            Ext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fileExt,</span></span>
<span class="line"><span style="color:#E1E4E8">            Name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fileNewName</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#F97583">        var</span><span style="color:#B392F0"> mmedia</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> _dbContext.Multimedia.</span><span style="color:#B392F0">Add</span><span style="color:#E1E4E8">(multimedia);</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext.</span><span style="color:#B392F0">SaveChanges</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">        //將檔案儲存在本機</span></span>
<span class="line"><span style="color:#6A737D">        //使用DI注入的FileService服務，呼叫WriteFile函式</span></span>
<span class="line"><span style="color:#6A737D">        //參數傳入檔案、檔名及副檔名</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> _file.</span><span style="color:#B392F0">WriteFile</span><span style="color:#E1E4E8">(file, fileNewName, fileExt);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        //將檔案轉為m3u8及ts檔</span></span>
<span class="line"><span style="color:#6A737D">        //傳入檔名及副檔名</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> _hls.</span><span style="color:#B392F0">WriteFile</span><span style="color:#E1E4E8">(fileNewName, fileExt);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>恭喜我們終於完成上傳了，接著只要在API中提供此服務即可</p>
<h3 id="建立上傳影片api">建立上傳影片API</h3>
<p>上傳影片的API我們把他放在<code>ApiControllers</code>目錄中，在目錄中建立<code>MultimediaController.cs</code>檔案存放API</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaController.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"api/[controller]"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">ApiController</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">Controller</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#B392F0"> _mmedia</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">MultimediaService</span><span style="color:#B392F0"> mmedia</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _mmedia </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> mmedia;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpPost</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IActionResult</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">PostMultimedia</span><span style="color:#E1E4E8">([</span><span style="color:#B392F0">FromForm</span><span style="color:#E1E4E8">] </span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (file.File.ContentType.</span><span style="color:#B392F0">Contains</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"video"</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#B392F0"> BadRequest</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        //呼叫上傳影片服務</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> _mmedia.</span><span style="color:#B392F0">CreateMultimedia</span><span style="color:#E1E4E8">(file);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>影片上傳終於告一段落了，接著是影片下載及串流</p>
<h2 id="影片串流">影片串流</h2>
<p>剛才已經把影片都轉檔好了，其實影片串流就只是開一個API讓前端丟請求過來拿檔案而已…嗎？
也沒這麼單純，我們要先從資料庫取得影片列表，我們需要裡面的檔案名稱，存取完資料庫還要開一個讀檔案的服務從目錄中讀取檔案，不過這應該比剛剛的簡單多了。</p>
<h3 id="從資料庫取得影片資訊">從資料庫取得影片資訊</h3>
<p>在<code>MultimediaService.cs</code>中加入<code>GetMultimediaViews</code>函式，取得<code>_dbContext</code>中<code>Multimedia</code>資料表的資料。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaService</span></span>
<span class="line"><span style="color:#E1E4E8">{    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> DBContext</span><span style="color:#B392F0"> _dbContext</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> FileService</span><span style="color:#B392F0"> _file</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> HLSService</span><span style="color:#B392F0"> _hls</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">DBContext</span><span style="color:#B392F0"> dbContext</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">FileService</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">HLSService</span><span style="color:#B392F0"> hls</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> dbContext;</span></span>
<span class="line"><span style="color:#E1E4E8">        _file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file;</span></span>
<span class="line"><span style="color:#E1E4E8">        _hls </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hls;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Multimedia</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">GetMultimediaViews</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> _dbContext.Multimedia.</span><span style="color:#B392F0">ToList</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> CreateMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>開好服務後由<code>MultimediaController</code>呼叫<code>GetMultimediaViews</code>服務，將資料表中的影音資訊清單返回給使用者</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaController.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"api/[controller]"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">ApiController</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">Controller</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#B392F0"> _mmedia</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">MultimediaService</span><span style="color:#B392F0"> mmedia</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _mmedia </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> mmedia;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpGet</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"List"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> IActionResult</span><span style="color:#B392F0"> GetMultimediaList</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">        List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Multimedia</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">list</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> _mmedia.</span><span style="color:#B392F0">GetMultimediaViews</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(list);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpPost</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IActionResult</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">PostMultimedia</span><span style="color:#E1E4E8">([</span><span style="color:#B392F0">FromForm</span><span style="color:#E1E4E8">] </span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="從目錄取得檔案">從目錄取得檔案</h3>
<p>先前寫入檔案時把程式寫在<code>FileService.cs</code>，讀取檔案我們一樣把函式放在這個檔案裡面</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//FileService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> FileService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#F97583"> string</span><span style="color:#B392F0"> basePath</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "./MultimediaFiles/"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> Stream</span><span style="color:#E1E4E8">? </span><span style="color:#B392F0">ReadFile</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileName</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        string</span><span style="color:#B392F0"> filePath</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Path.</span><span style="color:#B392F0">Combine</span><span style="color:#E1E4E8">(basePath, fileName);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (File.</span><span style="color:#B392F0">Exists</span><span style="color:#E1E4E8">(fileFullPath) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        //使用FileStream讀取並返回檔案Stream</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> FileStream</span><span style="color:#E1E4E8">(filePath, FileMode.Open, FileAccess.Read,</span></span>
<span class="line"><span style="color:#E1E4E8">            FileShare.ReadWrite, </span><span style="color:#79B8FF">4096</span><span style="color:#E1E4E8">, FileOptions.SequentialScan);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> WriteFile</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileName</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">string</span><span style="color:#B392F0"> fileExt</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>接著在<code>MultimediaService</code>中呼叫剛剛建立的讀取檔案函式，建立<code>GetMultimedia</code>服務</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaService.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaService</span></span>
<span class="line"><span style="color:#E1E4E8">{    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> DBContext</span><span style="color:#B392F0"> _dbContext</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> FileService</span><span style="color:#B392F0"> _file</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> HLSService</span><span style="color:#B392F0"> _hls</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">DBContext</span><span style="color:#B392F0"> dbContext</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">FileService</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">HLSService</span><span style="color:#B392F0"> hls</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _dbContext </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> dbContext;</span></span>
<span class="line"><span style="color:#E1E4E8">        _file </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> file;</span></span>
<span class="line"><span style="color:#E1E4E8">        _hls </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hls;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> Stream</span><span style="color:#B392F0"> GetMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#B392F0"> filename</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> _file.</span><span style="color:#B392F0">ReadFile</span><span style="color:#E1E4E8">(filename);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Multimedia</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">GetMultimediaViews</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#B392F0"> CreateMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>到這邊已經完成所有服務了，接著只要建立取得檔案的API即可</p>
<h3 id="建立串流api">建立串流API</h3>
<p>在<code>MultimediaController</code>中建立<code>GetHLSMultimedia</code>API函式，函式中呼叫<code>MultimediaService</code>中的<code>GetHLSMultimedia</code>方法，取得stream後使用<code>File</code>函式將stream返回給使用者，並指定Content-Type為<code>video/mp2t</code>。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#6A737D">//MultimediaController.cs</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"api/[controller]"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">ApiController</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">Controller</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#B392F0"> MultimediaService</span><span style="color:#B392F0"> _mmedia</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> MultimediaController</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">MultimediaService</span><span style="color:#B392F0"> mmedia</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        _mmedia </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> mmedia;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpGet</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"List"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#B392F0"> IActionResult</span><span style="color:#B392F0"> GetMultimediaList</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpGet</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"HLS/{FileName}"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IActionResult</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">GetHLSMultimedia</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">string</span><span style="color:#B392F0"> FileName</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#B392F0">        Stream</span><span style="color:#E1E4E8">? </span><span style="color:#B392F0">stream</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> _mmedia.</span><span style="color:#B392F0">GetHLSMultimedia</span><span style="color:#E1E4E8">(FileName);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (stream </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#B392F0"> NotFound</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> File</span><span style="color:#E1E4E8">(stream, </span><span style="color:#9ECBFF">"video/mp2t"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">HttpPost</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IActionResult</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">PostMultimedia</span><span style="color:#E1E4E8">([</span><span style="color:#B392F0">FromForm</span><span style="color:#E1E4E8">] </span><span style="color:#B392F0">IFormFile</span><span style="color:#B392F0"> file</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="呼叫api">呼叫API</h3>
<p>由於我們建立的是HttpGet方法，在瀏覽器網址列可以直接輸入網址呼叫API，在<code>MultimediaController</code>設定的路由是<code>/api/Multimedia/HLS/&#x3C;已轉檔後的檔名></code>，以檔名為<code>vxvi0clz.4od</code>的檔案為例，剛剛在轉檔的時候會轉出一個<code>vxvi0clz.4od.m3u8</code>檔案及<code>vxvi0clz.4od0.ts</code>,<code>vxvi0clz.4od1.ts</code>…等多個ts檔案，存取時呼叫<code>/api/Multimedia/HLS/vxvi0clz.4od.m3u8</code>即可取得檔案。</p>
<h6 id="參考資料">參考資料</h6>
<ul>
<li><a href="https://www.twblogs.net/a/5c7f9ef7bd9eee35fc1345d5">ASP.NET 使用FFmpeg實現MP4轉換M3U8</a></li>
<li><a href="https://stackoverflow.com/questions/54398461/asp-net-core-2-0-not-serving-some-static-file-like-m3u8">Asp.Net Core 2.0 not serving some static file like m3u8</a></li>
<li><a href="https://ithelp.ithome.com.tw/articles/10310697">JS筆記-前端撥放m3u8的兩種方法</a></li>
</ul>  </div>  <div class="post-footer" data-astro-cid-ctzdi7mj> <div class="post-tags" data-astro-cid-ctzdi7mj> <span class="post-tags-label" data-astro-cid-ctzdi7mj>Topic</span> <div class="post-tags-list" data-astro-cid-ctzdi7mj> <a class="post-tag-badge" href="/tag/asp-net-core" data-astro-cid-ctzdi7mj> ASP.NET Core </a><a class="post-tag-badge" href="/tag/csharp" data-astro-cid-ctzdi7mj> C# </a><a class="post-tag-badge" href="/tag/Streaming" data-astro-cid-ctzdi7mj> Streaming </a> </div> </div> <div class="post-nav" data-astro-cid-ctzdi7mj> <div class="post-nav-half" data-astro-cid-ctzdi7mj> <a class="post-nav-prev" href="difference-between-ienumerable-iqueryable-linq" data-astro-cid-ctzdi7mj> <span class="post-nav-icon-left" data-astro-cid-ctzdi7mj></span> <h2 class="post-nav-title" data-astro-cid-ctzdi7mj>IEnumerable或IQueryable物件在進行LINQ查詢時的差異</h2> <p class="post-nav-abstract" data-astro-cid-ctzdi7mj>當使用LINQ查詢時，執行對象是IEnumerable或是IQueryable有很大的差異。</p> <p class="post-nav-metadata" data-astro-cid-ctzdi7mj> 2023-09-25T00:00:00+08:00 </p> </a> </div> <div class="post-nav-half" data-astro-cid-ctzdi7mj> <a class="post-nav-next" href="promise-in-javascript" data-astro-cid-ctzdi7mj> <span class="post-nav-icon-right" data-astro-cid-ctzdi7mj></span> <h2 class="post-nav-title" data-astro-cid-ctzdi7mj>Promise in JavaScript</h2> <p class="post-nav-abstract" data-astro-cid-ctzdi7mj>Promise是Javascript提供的建構函式，用於建構Promise物件，該物件會存放非同步事件的結果。</p> <p class="post-nav-metadata" data-astro-cid-ctzdi7mj> 2023-08-29T00:00:00+08:00 </p> </a> </div> </div> <div class="post-comments" data-astro-cid-ctzdi7mj> <script src="https://utteranc.es/client.js" repo="vincent87720/BlogComments" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script> </div> </div>  </div> </article>  <div class="nav-outer" data-astro-cid-bpgok6sl> <nav class="nav-inner" data-astro-cid-bpgok6sl> <span data-astro-cid-bpgok6sl>柴魚筆記 © 2019-2024</span> <div class="nav-external-link" data-astro-cid-bpgok6sl> <a href="https://github.com/vincent87720" data-astro-cid-bpgok6sl>Github</a><a href="https://www.linkedin.com/in/vincent87720" data-astro-cid-bpgok6sl>LinkedIn</a> </div> <div class="nav-item-grow" data-astro-cid-bpgok6sl></div> <span class="nav-pubinfo" data-astro-cid-bpgok6sl>
Published with
<a href="https://astro.build" target="_blank" data-astro-cid-bpgok6sl>Astro</a>
• Theme modified from
<a href="https://github.com/zutrinken/attila" target="_blank" data-astro-cid-bpgok6sl>Attila</a>
• Technical support by
<a href="https://millieattic-millieqius-projects.vercel.app" target="_blank" data-astro-cid-bpgok6sl>Millie</a> </span> </nav> </div>   </body></html>
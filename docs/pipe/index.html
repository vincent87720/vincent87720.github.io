<!DOCTYPE html><html lang="zh-Hant"> <head><meta charset="UTF-8"><meta name="description" content="柴魚筆記"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.10.3"><title>柴魚筆記</title><link rel="stylesheet" href="/assets/style.HZtN7SYH.css"></head> <body>  <div class="nav-outer" data-astro-cid-pux6a34n> <nav class="nav-inner" data-astro-cid-pux6a34n> <span class="logo" data-astro-cid-pux6a34n> <a href="/" data-astro-cid-pux6a34n> <img src="/favicon.svg" data-astro-cid-pux6a34n> </a> </span> <ul data-astro-cid-pux6a34n> <li data-astro-cid-pux6a34n> <a href="/" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Home</span> </a> </li><li data-astro-cid-pux6a34n> <a href="/author/Katsuobushi" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Author</span> </a> </li><li data-astro-cid-pux6a34n> <a href="/tags" data-astro-cid-pux6a34n> <span data-astro-cid-pux6a34n>Tags</span> </a> </li> </ul> </nav> </div>   <header class="main-header has-cover" data-astro-cid-yl355ysp> <div class="content" data-astro-cid-yl355ysp> <div class="header-box" data-astro-cid-yl355ysp>  <div class="post-info" data-astro-cid-qwcrhz7j> <div class="post-type" data-astro-cid-qwcrhz7j> <span data-astro-cid-qwcrhz7j>Article</span>  <span class="post-type-dash" data-astro-cid-qwcrhz7j>－</span> <span data-astro-cid-qwcrhz7j>OperatingSystem</span>  </div> <h1 class="post-title" data-astro-cid-qwcrhz7j>Pipe</h1> <div class="post-metadata" data-astro-cid-qwcrhz7j> <span class="author-avatar" data-astro-cid-qwcrhz7j> <img src="/favicon.svg" data-astro-cid-qwcrhz7j> </span> <div class="metadata-right" data-astro-cid-qwcrhz7j> <h4 class="metadata-author" data-astro-cid-qwcrhz7j>Katsuobushi</h4> <span class="metadata-datetime" data-astro-cid-qwcrhz7j>2022-10-29T03:00:00+08:00</span> </div> </div> </div>   </div> <div class="main-cover" data-astro-cid-yl355ysp> <img src="/assets/Pipe_Diana_unsplash.C05pcX68_1hihOq.webp" alt="" data-astro-cid-yl355ysp width="2749" height="1820" loading="lazy" decoding="async"> </div> </div> </header>  <article> <div class="content"> <div class="markdown">  <p>pipe()用於在兩個有關係的process（通常是父子或是兄弟process）之間通信
假設有A和B兩個process，pipe()建立之後可以用A讀或寫經由pipe傳送到B的寫或讀</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;unistd.h></span></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> pipe</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> pipefd</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"></span></code></pre>
<p>使用pipefd表示讀或寫，pipefd[0]用於讀，pipefd[1]用於寫</p>
<p>在建立管道之後需要fork出一個process，所以目前有父process及fork出來的子process
接著利用cpid判斷哪個process是父process哪個是子process
當父process的寫端需要使用stdout寫出數據給子process的讀端讀取時，這時需要將父process沒有用到的讀端及子process沒用到的寫端關閉
接著就是在父process使用write，及在子process使用read，即可完成父子process之間的通信</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;sys/wait.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;stdio.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;stdlib.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;unistd.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;string.h></span></span>
<span class="line"><span style="color:#F97583">#include</span><span style="color:#9ECBFF"> &#x3C;errno.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">int</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">char*</span><span style="color:#FFAB70"> argv</span><span style="color:#E1E4E8">[])</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> pipefd[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    pid_t</span><span style="color:#E1E4E8"> cpid;</span></span>
<span class="line"><span style="color:#F97583">    char</span><span style="color:#E1E4E8"> buf[</span><span style="color:#79B8FF">128</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> readlen;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (argc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"Usage: </span><span style="color:#79B8FF">%s</span><span style="color:#9ECBFF"> &#x3C;string></span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, argv[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">pipe</span><span style="color:#E1E4E8">(pipefd) </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"pipe: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">strerror</span><span style="color:#E1E4E8">(errno));</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cpid </span><span style="color:#F97583">=</span><span style="color:#B392F0"> fork</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (cpid </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">        fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"fork: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">strerror</span><span style="color:#E1E4E8">(errno));</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">0</span><span style="color:#F97583"> ==</span><span style="color:#E1E4E8"> cpid) {</span><span style="color:#6A737D"> /* 子進程 */</span></span>
<span class="line"><span style="color:#B392F0">        close</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]);</span><span style="color:#6A737D"> /* 子進程關閉寫端 */</span></span>
<span class="line"><span style="color:#E1E4E8">        readlen </span><span style="color:#F97583">=</span><span style="color:#B392F0"> read</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">], buf,</span></span>
<span class="line"><span style="color:#79B8FF">                       128</span><span style="color:#E1E4E8">);</span><span style="color:#6A737D"> //子進程阻塞在讀上，等待父進程寫</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (readlen </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#B392F0">            fprintf</span><span style="color:#E1E4E8">(stderr, </span><span style="color:#9ECBFF">"read: </span><span style="color:#79B8FF">%s\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">strerror</span><span style="color:#E1E4E8">(errno));</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">        write</span><span style="color:#E1E4E8">(STDOUT_FILENO, buf, readlen);</span></span>
<span class="line"><span style="color:#B392F0">        write</span><span style="color:#E1E4E8">(STDOUT_FILENO, </span><span style="color:#9ECBFF">"</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">        close</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]);</span><span style="color:#6A737D"> //讀完之後關閉讀描述符</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span><span style="color:#6A737D"> /* 父進程 */</span></span>
<span class="line"><span style="color:#B392F0">        close</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]);</span><span style="color:#6A737D"> /*父進程關閉沒用的讀端 */</span></span>
<span class="line"><span style="color:#B392F0">        sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">        write</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], argv[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], </span><span style="color:#B392F0">strlen</span><span style="color:#E1E4E8">(argv[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]));</span><span style="color:#6A737D"> //父進程開始寫</span></span>
<span class="line"><span style="color:#B392F0">        close</span><span style="color:#E1E4E8">(pipefd[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]);</span><span style="color:#6A737D"> /* 父進程關閉寫描述符 */</span></span>
<span class="line"><span style="color:#B392F0">        wait</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">NULL</span><span style="color:#E1E4E8">);</span><span style="color:#6A737D"> /* 父進程等待子進程退出，回收子進程資源 */</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="參考資料">參考資料</h2>
<p><a href="https://www.cntofu.com/book/46/linux_system/pipehe_fifo.md">pipe和FIFO</a></p>  </div>  <div class="post-footer" data-astro-cid-ctzdi7mj> <div class="post-tags" data-astro-cid-ctzdi7mj> <span class="post-tags-label" data-astro-cid-ctzdi7mj>Topic</span> <div class="post-tags-list" data-astro-cid-ctzdi7mj> <a class="post-tag-badge" href="/tag/OperatingSystem" data-astro-cid-ctzdi7mj> OperatingSystem </a> </div> </div> <div class="post-nav" data-astro-cid-ctzdi7mj> <div class="post-nav-half" data-astro-cid-ctzdi7mj> <a class="post-nav-prev" href="/python-get-binary-path" data-astro-cid-ctzdi7mj> <span class="post-nav-icon-left" data-astro-cid-ctzdi7mj></span> <h2 class="post-nav-title" data-astro-cid-ctzdi7mj>Python取得打包成binary後的路徑</h2> <p class="post-nav-abstract" data-astro-cid-ctzdi7mj>使用pyinstaller打包後的執行檔在執行時有可能會發生實際執行的檔案位於Temporary內的情況，這時就必須用以下方法取得實際exe檔案所在的路徑</p> <p class="post-nav-metadata" data-astro-cid-ctzdi7mj> 2022-10-29T04:00:00+08:00 </p> </a> </div> <div class="post-nav-half" data-astro-cid-ctzdi7mj> <a class="post-nav-next" href="/memory-management" data-astro-cid-ctzdi7mj> <span class="post-nav-icon-right" data-astro-cid-ctzdi7mj></span> <h2 class="post-nav-title" data-astro-cid-ctzdi7mj>Memory management</h2> <p class="post-nav-abstract" data-astro-cid-ctzdi7mj>Stack, Heap &amp; GC</p> <p class="post-nav-metadata" data-astro-cid-ctzdi7mj> 2022-10-29T01:00:00+08:00 </p> </a> </div> </div> <div class="post-comments" data-astro-cid-ctzdi7mj> <script src="https://utteranc.es/client.js" repo="vincent87720/BlogComments" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async></script> </div> </div>  </div> </article>  <div class="nav-outer" data-astro-cid-bpgok6sl> <nav class="nav-inner" data-astro-cid-bpgok6sl> <span data-astro-cid-bpgok6sl>柴魚筆記 © 2019-2024</span> <div class="nav-external-link" data-astro-cid-bpgok6sl> <a href="https://github.com/vincent87720" data-astro-cid-bpgok6sl>Github</a><a href="https://www.linkedin.com/in/vincent87720" data-astro-cid-bpgok6sl>LinkedIn</a> </div> <div class="nav-item-grow" data-astro-cid-bpgok6sl></div> <span class="nav-pubinfo" data-astro-cid-bpgok6sl>
Published with
<a href="https://astro.build" target="_blank" data-astro-cid-bpgok6sl>Astro</a>
• Theme modified from
<a href="https://github.com/zutrinken/attila" target="_blank" data-astro-cid-bpgok6sl>Attila</a>
• Technical support by
<a href="https://millieattic-millieqius-projects.vercel.app" target="_blank" data-astro-cid-bpgok6sl>Millie</a> </span> </nav> </div>   </body></html>